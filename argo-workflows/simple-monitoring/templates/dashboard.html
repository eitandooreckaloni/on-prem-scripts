<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argo Workflows Monitor - Comprehensive Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .button-group {
            margin-top: 15px;
        }
        .refresh-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        .refresh-button:hover {
            background: #218838;
        }
        .filter-button {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        .filter-button:hover {
            background: #5a35a3;
        }
        .clear-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        .clear-button:hover {
            background: #5a6268;
        }

        /* Anomaly Alert */
        .anomaly-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(255,107,107,0.3);
            display: none;
        }

        /* Filters */
        .filters-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 14px;
        }
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-full-width {
            grid-column: 1 / -1;
        }
        .chart-section-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 30px 0 20px 0;
            text-align: center;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .table-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-succeeded {
            background: #d4edda;
            color: #155724;
        }
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }
        .duration-cell {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 600;
        }
        .duration-fast {
            color: #28a745;
        }
        .duration-normal {
            color: #333;
        }
        .duration-slow {
            color: #dc3545;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #667eea;
        }

        /* No data state */
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .no-data h3 {
            margin-bottom: 10px;
        }
        .no-data p {
            margin-bottom: 20px;
        }

        /* Collapsible sections */
        .collapsible {
            background: #667eea;
            color: white;
            cursor: pointer;
            padding: 15px 20px;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
            width: 100%;
        }
        .collapsible:hover {
            background: #5a6fd8;
        }
        .collapsible:after {
            content: '\002B';
            color: white;
            font-weight: bold;
            float: right;
        }
        .collapsible.active:after {
            content: "\2212";
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Argo Workflows Monitor</h1>
        <p>Comprehensive real-time performance tracking with anomaly detection and filtering</p>
        <div class="button-group">
            <button class="refresh-button" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="refresh-button" onclick="collectData()">üìä Collect Now</button>
            <button class="filter-button" onclick="toggleFilters()">üîç Toggle Filters</button>
        </div>
    </div>

    <!-- Anomaly Alert -->
    <div id="anomaly-alert" class="anomaly-alert">
        <div>‚ö†Ô∏è Performance Anomalies Detected!</div>
        <div id="anomaly-count">Loading...</div>
    </div>

    <!-- Filters Section -->
    <div id="filters-section" class="filters-container" style="display: none;">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="workflow-filter">Workflow Name:</label>
                <select id="workflow-filter">
                    <option value="">All Workflows</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="task-filter">Task Name:</label>
                <select id="task-filter">
                    <option value="">All Tasks</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="days-filter">Time Period:</label>
                <select id="days-filter">
                    <option value="1">Last 24 hours</option>
                    <option value="3">Last 3 days</option>
                    <option value="7" selected>Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="filter-button" onclick="applyFilters()">üîç Apply Filters</button>
                <button class="clear-button" onclick="clearFilters()">‚úñÔ∏è Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div class="loading-spinner" id="loading-spinner">
        <div>üîÑ Loading data...</div>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <h3>Total Workflows</h3>
            <div class="stat-value" id="total-workflows">{{ stats.recent_workflows | length or 0 }}</div>
        </div>
        <div class="stat-card">
            <h3>Succeeded</h3>
            <div class="stat-value" style="color: #28a745;" id="succeeded-workflows">
                {% set succeeded_count = 0 %}
                {% for workflow in stats.recent_workflows %}
                    {% if workflow.status == 'Succeeded' %}
                        {% set succeeded_count = succeeded_count + 1 %}
                    {% endif %}
                {% endfor %}
                {{ succeeded_count }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Failed</h3>
            <div class="stat-value" style="color: #dc3545;" id="failed-workflows">
                {% set failed_count = 0 %}
                {% for workflow in stats.recent_workflows %}
                    {% if workflow.status == 'Failed' %}
                        {% set failed_count = failed_count + 1 %}
                    {% endif %}
                {% endfor %}
                {{ failed_count }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Average Duration</h3>
            <div class="stat-value" style="color: #fd7e14;" id="avg-duration">
                {% set total_duration = 0 %}
                {% set count = 0 %}
                {% for workflow in stats.recent_workflows %}
                    {% if workflow.duration_seconds and workflow.duration_seconds > 0 %}
                        {% set total_duration = total_duration + workflow.duration_seconds %}
                        {% set count = count + 1 %}
                    {% endif %}
                {% endfor %}
                {% if count > 0 %}
                    {{ "%.0f"|format(total_duration / count) }}s
                {% else %}
                    0s
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <h3>Success Rate</h3>
            <div class="stat-value" style="color: #17a2b8;" id="success-rate">
                {% if stats.recent_workflows | length > 0 %}
                    {{ "%.1f"|format((succeeded_count / (stats.recent_workflows | length)) * 100) }}%
                {% else %}
                    0%
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <h3>Total Anomalies</h3>
            <div class="stat-value" style="color: #dc3545;" id="total-anomalies">0</div>
        </div>
    </div>

    <div class="chart-section-title">üìä Workflow Performance Analytics</div>

    <!-- Charts -->
    <div class="charts-grid">
        <!-- Status Distribution -->
        <div class="chart-container">
            <div id="status-chart"></div>
        </div>
        
        <!-- Workflow Duration Comparison -->
        <div class="chart-container">
            <div id="workflow-duration-chart"></div>
        </div>
        
        <!-- Task Performance Breakdown -->
        <div class="chart-container chart-full-width">
            <div id="task-breakdown-chart"></div>
        </div>
        
        <!-- Timeline Chart -->
        <div class="chart-container chart-full-width">
            <div id="timeline-chart"></div>
        </div>
        
        <!-- Anomalies Chart -->
        <div class="chart-container chart-full-width">
            <div id="anomalies-chart"></div>
        </div>
    </div>

    <!-- Recent Workflows Table -->
    <div class="table-container">
        <div class="table-header">
            <span>Recent Workflows</span>
            <span class="table-count" id="workflows-count">{{ stats.recent_workflows | length }} workflows</span>
        </div>
        <table id="workflows-table">
            <thead>
                <tr>
                    <th>Workflow Name</th>
                    <th>Status</th>
                    <th>Duration</th>
                    <th>Created At</th>
                    <th>Tasks</th>
                    <th>Success Rate</th>
                </tr>
            </thead>
            <tbody id="workflows-tbody">
                {% for workflow in stats.recent_workflows %}
                <tr>
                    <td>{{ workflow.name }}</td>
                    <td>
                        <span class="status-badge status-{{ workflow.status.lower() }}">
                            {{ workflow.status }}
                        </span>
                    </td>
                    <td class="duration-cell">
                        {% if workflow.duration_seconds and workflow.duration_seconds > 0 %}
                            <span class="{% if workflow.duration_seconds < 30 %}duration-fast{% elif workflow.duration_seconds > 120 %}duration-slow{% else %}duration-normal{% endif %}">
                                {{ "%.1f"|format(workflow.duration_seconds) }}s
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ workflow.created_at[:19] if workflow.created_at else '-' }}</td>
                    <td>{{ workflow.task_count or 0 }}</td>
                    <td>
                        {% if workflow.status == 'Succeeded' %}
                            <span style="color: #28a745;">100%</span>
                        {% elif workflow.status == 'Failed' %}
                            <span style="color: #dc3545;">0%</span>
                        {% else %}
                            <span style="color: #6c757d;">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Collapsible Task Performance Section -->
    <button type="button" class="collapsible" onclick="toggleCollapsible('task-performance-content')">
        üîß Task Performance Details
    </button>
    <div class="collapsible-content" id="task-performance-content">
        <div class="table-container" style="margin: 0; border-radius: 0;">
            <div class="table-header">
                <span>Task Performance</span>
                <span class="table-count" id="tasks-count">{{ stats.task_durations | length }} tasks</span>
            </div>
            <table id="tasks-table">
                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th>Average Duration</th>
                        <th>Executions</th>
                        <th>Performance Level</th>
                    </tr>
                </thead>
                <tbody id="tasks-tbody">
                    {% for task in stats.task_durations %}
                    <tr>
                        <td>{{ task.task_name }}</td>
                        <td class="duration-cell">
                            <span class="{% if task.avg_duration < 30 %}duration-fast{% elif task.avg_duration > 120 %}duration-slow{% else %}duration-normal{% endif %}">
                                {{ "%.1f"|format(task.avg_duration) }}s
                            </span>
                        </td>
                        <td>{{ task.execution_count or 1 }}</td>
                        <td>
                            {% if task.avg_duration < 30 %}
                                <span class="status-badge status-succeeded">Fast</span>
                            {% elif task.avg_duration > 120 %}
                                <span class="status-badge status-failed">Slow</span>
                            {% else %}
                                <span class="status-badge status-running">Normal</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Collapsible Anomalies Section -->
    <button type="button" class="collapsible" onclick="toggleCollapsible('anomalies-content')">
        ‚ö†Ô∏è Performance Anomalies
    </button>
    <div class="collapsible-content" id="anomalies-content">
        <div class="table-container" style="margin: 0; border-radius: 0;">
            <div class="table-header">
                <span>Detected Anomalies</span>
                <span class="table-count" id="anomalies-count">0 anomalies</span>
            </div>
            <div class="no-data" id="no-anomalies">
                <h3>No Anomalies Detected</h3>
                <p>All workflows and tasks are performing within normal parameters.</p>
            </div>
            <table id="anomalies-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Duration</th>
                        <th>Average</th>
                        <th>Deviation</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="anomalies-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let currentFilters = {
            workflow_name: '',
            task_name: '',
            days: 7
        };
        let anomaliesData = {};
        let workflowNames = [];
        let taskNames = [];
        let filteredData = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            createCharts();
            loadAnomalies();
            loadFilterOptions();
            
            // Auto-refresh every 2 minutes
            setInterval(refreshData, 120000);
        });

        // Create comprehensive charts
        function createCharts() {
            // Get data from server-side rendering
            const workflowData = {{ stats.recent_workflows | tojson }};
            const taskData = {{ stats.task_durations | tojson }};
            
            // Status Distribution Chart
            const statusCounts = {};
            workflowData.forEach(wf => {
                statusCounts[wf.status] = (statusCounts[wf.status] || 0) + 1;
            });
            
            if (Object.keys(statusCounts).length > 0) {
                const statusChart = {
                    data: [{
                        labels: Object.keys(statusCounts),
                        values: Object.values(statusCounts),
                        type: 'pie',
                        hole: 0.3,
                        marker: {
                            colors: ['#28a745', '#dc3545', '#ffc107', '#17a2b8']
                        }
                    }],
                    layout: {
                        title: 'Workflow Status Distribution',
                        height: 400,
                        showlegend: true
                    }
                };
                Plotly.newPlot('status-chart', statusChart.data, statusChart.layout, {responsive: true});
            }

            // Workflow Duration Chart
            const completedWorkflows = workflowData.filter(wf => wf.duration_seconds && wf.duration_seconds > 0);
            if (completedWorkflows.length > 0) {
                const workflowChart = {
                    data: [{
                        x: completedWorkflows.map(wf => wf.name),
                        y: completedWorkflows.map(wf => wf.duration_seconds),
                        type: 'bar',
                        marker: {
                            color: '#667eea',
                            line: { color: '#4a5568', width: 1 }
                        },
                        text: completedWorkflows.map(wf => `${wf.duration_seconds.toFixed(1)}s`),
                        textposition: 'auto'
                    }],
                    layout: {
                        title: 'Workflow Duration Comparison',
                        xaxis: { title: 'Workflow Name', tickangle: -45 },
                        yaxis: { title: 'Duration (seconds)' },
                        height: 400,
                        margin: { b: 120 }
                    }
                };
                Plotly.newPlot('workflow-duration-chart', workflowChart.data, workflowChart.layout, {responsive: true});
            }

            // Task Breakdown Chart
            if (taskData && taskData.length > 0) {
                const taskChart = {
                    data: [{
                        x: taskData.map(task => task.task_name),
                        y: taskData.map(task => task.avg_duration),
                        type: 'bar',
                        marker: {
                            color: taskData.map(task => 
                                task.avg_duration < 30 ? '#28a745' : 
                                task.avg_duration < 120 ? '#ffc107' : '#dc3545'
                            )
                        },
                        text: taskData.map(task => `${task.avg_duration.toFixed(1)}s`),
                        textposition: 'auto'
                    }],
                    layout: {
                        title: 'Task Performance Breakdown',
                        xaxis: { title: 'Task Name', tickangle: -45 },
                        yaxis: { title: 'Average Duration (seconds)' },
                        height: 400,
                        margin: { b: 120 }
                    }
                };
                Plotly.newPlot('task-breakdown-chart', taskChart.data, taskChart.layout, {responsive: true});
            }

            // Timeline Chart
            if (completedWorkflows.length > 0) {
                const fig = {
                    data: [],
                    layout: {
                        title: 'Workflow Duration Timeline',
                        xaxis: { title: 'Execution Time' },
                        yaxis: { title: 'Duration (seconds)' },
                        height: 400,
                        hovermode: 'closest'
                    }
                };
                
                // Group by workflow name
                const workflowNames = [...new Set(completedWorkflows.map(wf => wf.name))];
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
                
                workflowNames.forEach((wfName, i) => {
                    const wfData = completedWorkflows.filter(wf => wf.name === wfName);
                    fig.data.push({
                        x: wfData.map(wf => wf.created_at),
                        y: wfData.map(wf => wf.duration_seconds),
                        mode: 'markers+lines',
                        name: wfName,
                        marker: { size: 10, color: colors[i % colors.length] },
                        line: { width: 2, color: colors[i % colors.length] }
                    });
                });
                
                Plotly.newPlot('timeline-chart', fig.data, fig.layout, {responsive: true});
            }
        }

        // Load anomalies data
        async function loadAnomalies() {
            try {
                const response = await fetch('/api/anomalies?days=7');
                anomaliesData = await response.json();
                updateAnomalyAlert();
                updateAnomaliesSection();
                createAnomaliesChart();
            } catch (error) {
                console.error('Error loading anomalies:', error);
            }
        }

        // Update anomaly alert
        function updateAnomalyAlert() {
            const totalAnomalies = anomaliesData.total_anomalies || 0;
            const alertDiv = document.getElementById('anomaly-alert');
            const countDiv = document.getElementById('anomaly-count');
            const totalAnomaliesEl = document.getElementById('total-anomalies');
            
            totalAnomaliesEl.textContent = totalAnomalies;
            
            if (totalAnomalies > 0) {
                alertDiv.style.display = 'block';
                countDiv.textContent = `${totalAnomalies} anomalies found in recent executions`;
            } else {
                alertDiv.style.display = 'none';
            }
        }

        // Update anomalies section
        function updateAnomaliesSection() {
            const anomaliesCount = document.getElementById('anomalies-count');
            const noAnomalies = document.getElementById('no-anomalies');
            const anomaliesTable = document.getElementById('anomalies-table');
            const anomaliesTbody = document.getElementById('anomalies-tbody');
            
            const totalAnomalies = (anomaliesData.workflow_anomalies?.length || 0) + 
                                  (anomaliesData.task_anomalies?.length || 0);
            
            anomaliesCount.textContent = `${totalAnomalies} anomalies`;
            
            if (totalAnomalies === 0) {
                noAnomalies.style.display = 'block';
                anomaliesTable.style.display = 'none';
                return;
            }
            
            noAnomalies.style.display = 'none';
            anomaliesTable.style.display = 'table';
            
            // Clear and populate table
            anomaliesTbody.innerHTML = '';
            
            // Add workflow anomalies
            (anomaliesData.workflow_anomalies || []).forEach(anomaly => {
                const row = document.createElement('tr');
                const deviation = ((anomaly.duration_seconds / anomaly.avg_duration - 1) * 100).toFixed(1);
                row.innerHTML = `
                    <td><span class="status-badge status-running">Workflow</span></td>
                    <td>${anomaly.name}</td>
                    <td class="duration-cell duration-slow">${anomaly.duration_seconds.toFixed(1)}s</td>
                    <td class="duration-cell">${anomaly.avg_duration.toFixed(1)}s</td>
                    <td><span style="color: #dc3545;">+${deviation}%</span></td>
                    <td>${anomaly.created_at ? anomaly.created_at.substring(0, 19) : '-'}</td>
                `;
                anomaliesTbody.appendChild(row);
            });
            
            // Add task anomalies
            (anomaliesData.task_anomalies || []).forEach(anomaly => {
                const row = document.createElement('tr');
                const deviation = ((anomaly.duration_seconds / anomaly.avg_duration - 1) * 100).toFixed(1);
                row.innerHTML = `
                    <td><span class="status-badge status-failed">Task</span></td>
                    <td>${anomaly.task_name} (${anomaly.workflow_name})</td>
                    <td class="duration-cell duration-slow">${anomaly.duration_seconds.toFixed(1)}s</td>
                    <td class="duration-cell">${anomaly.avg_duration.toFixed(1)}s</td>
                    <td><span style="color: #dc3545;">+${deviation}%</span></td>
                    <td>${anomaly.created_at ? anomaly.created_at.substring(0, 19) : '-'}</td>
                `;
                anomaliesTbody.appendChild(row);
            });
        }

        // Create anomalies chart
        function createAnomaliesChart() {
            if (!anomaliesData.workflow_anomalies && !anomaliesData.task_anomalies) {
                return;
            }
            
            const workflowAnomalies = anomaliesData.workflow_anomalies || [];
            const taskAnomalies = anomaliesData.task_anomalies || [];
            
            if (workflowAnomalies.length === 0 && taskAnomalies.length === 0) {
                return;
            }
            
            const fig = {
                data: [],
                layout: {
                    title: 'Performance Anomalies Over Time',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Duration (seconds)' },
                    height: 400,
                    hovermode: 'closest'
                }
            };
            
            if (workflowAnomalies.length > 0) {
                fig.data.push({
                    x: workflowAnomalies.map(a => a.created_at),
                    y: workflowAnomalies.map(a => a.duration_seconds),
                    mode: 'markers',
                    name: 'Workflow Anomalies',
                    marker: { size: 12, color: '#dc3545', symbol: 'x' },
                    text: workflowAnomalies.map(a => `${a.name}: ${a.duration_seconds.toFixed(1)}s (avg: ${a.avg_duration.toFixed(1)}s)`),
                    hovertemplate: '%{text}<extra></extra>'
                });
            }
            
            if (taskAnomalies.length > 0) {
                fig.data.push({
                    x: taskAnomalies.map(a => a.created_at),
                    y: taskAnomalies.map(a => a.duration_seconds),
                    mode: 'markers',
                    name: 'Task Anomalies',
                    marker: { size: 12, color: '#ffc107', symbol: 'diamond' },
                    text: taskAnomalies.map(a => `${a.task_name} (${a.workflow_name}): ${a.duration_seconds.toFixed(1)}s (avg: ${a.avg_duration.toFixed(1)}s)`),
                    hovertemplate: '%{text}<extra></extra>'
                });
            }
            
            Plotly.newPlot('anomalies-chart', fig.data, fig.layout, {responsive: true});
        }

        // Load filter options
        async function loadFilterOptions() {
            try {
                const [workflowResponse, taskResponse] = await Promise.all([
                    fetch('/api/workflows/names'),
                    fetch('/api/tasks/names')
                ]);
                
                workflowNames = await workflowResponse.json();
                taskNames = await taskResponse.json();
                
                populateFilterDropdowns();
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            const workflowSelect = document.getElementById('workflow-filter');
            const taskSelect = document.getElementById('task-filter');
            
            // Clear existing options (except "All")
            workflowSelect.innerHTML = '<option value="">All Workflows</option>';
            taskSelect.innerHTML = '<option value="">All Tasks</option>';
            
            // Add workflow options
            workflowNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                workflowSelect.appendChild(option);
            });
            
            // Add task options
            taskNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                taskSelect.appendChild(option);
            });
        }

        // Toggle filters section
        function toggleFilters() {
            const filtersSection = document.getElementById('filters-section');
            if (filtersSection.style.display === 'none') {
                filtersSection.style.display = 'block';
            } else {
                filtersSection.style.display = 'none';
            }
        }

        // Apply filters
        async function applyFilters() {
            const workflowName = document.getElementById('workflow-filter').value;
            const taskName = document.getElementById('task-filter').value;
            const days = document.getElementById('days-filter').value;
            
            currentFilters = { workflow_name: workflowName, task_name: taskName, days: days };
            
            showLoading();
            
            try {
                const params = new URLSearchParams();
                if (workflowName) params.append('workflow_name', workflowName);
                if (taskName) params.append('task_name', taskName);
                params.append('days', days);
                params.append('limit', '200');
                
                const response = await fetch(`/api/workflows/filtered?${params}`);
                filteredData = await response.json();
                
                updateDashboardWithFilters();
            } catch (error) {
                console.error('Error applying filters:', error);
            } finally {
                hideLoading();
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('workflow-filter').value = '';
            document.getElementById('task-filter').value = '';
            document.getElementById('days-filter').value = '7';
            
            currentFilters = { workflow_name: '', task_name: '', days: 7 };
            filteredData = null;
            
            // Reload the page to show all data
            location.reload();
        }

        // Update dashboard with filtered data
        function updateDashboardWithFilters() {
            if (!filteredData) return;
            
            // Update statistics
            document.getElementById('total-workflows').textContent = filteredData.total_workflows;
            document.getElementById('workflows-count').textContent = `${filteredData.total_workflows} workflows`;
            
            const succeeded = filteredData.workflows.filter(w => w.status === 'Succeeded').length;
            const failed = filteredData.workflows.filter(w => w.status === 'Failed').length;
            
            document.getElementById('succeeded-workflows').textContent = succeeded;
            document.getElementById('failed-workflows').textContent = failed;
            
            if (filteredData.total_workflows > 0) {
                const successRate = (succeeded / filteredData.total_workflows * 100).toFixed(1);
                document.getElementById('success-rate').textContent = `${successRate}%`;
                
                const avgDuration = filteredData.workflows
                    .filter(w => w.duration_seconds > 0)
                    .reduce((sum, w, _, arr) => sum + w.duration_seconds / arr.length, 0);
                document.getElementById('avg-duration').textContent = `${avgDuration.toFixed(0)}s`;
            }
            
            // Update workflows table
            updateWorkflowsTable(filteredData.workflows);
            
            // Update charts with filtered data
            updateChartsWithFilteredData(filteredData);
        }

        // Update workflows table
        function updateWorkflowsTable(workflows) {
            const tbody = document.getElementById('workflows-tbody');
            tbody.innerHTML = '';
            
            workflows.forEach(workflow => {
                const row = document.createElement('tr');
                const duration = workflow.duration_seconds > 0 ? `${workflow.duration_seconds.toFixed(1)}s` : '-';
                const durationClass = workflow.duration_seconds < 30 ? 'duration-fast' : 
                                    workflow.duration_seconds > 120 ? 'duration-slow' : 'duration-normal';
                
                row.innerHTML = `
                    <td>${workflow.name}</td>
                    <td><span class="status-badge status-${workflow.status.toLowerCase()}">${workflow.status}</span></td>
                    <td class="duration-cell"><span class="${durationClass}">${duration}</span></td>
                    <td>${workflow.created_at ? workflow.created_at.substring(0, 19) : '-'}</td>
                    <td>${workflow.task_count || 0}</td>
                    <td>
                        ${workflow.status === 'Succeeded' ? '<span style="color: #28a745;">100%</span>' :
                          workflow.status === 'Failed' ? '<span style="color: #dc3545;">0%</span>' :
                          '<span style="color: #6c757d;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update charts with filtered data
        function updateChartsWithFilteredData(data) {
            // Status distribution
            const statusCounts = {};
            data.workflows.forEach(wf => {
                statusCounts[wf.status] = (statusCounts[wf.status] || 0) + 1;
            });
            
            if (Object.keys(statusCounts).length > 0) {
                const statusChart = {
                    data: [{
                        labels: Object.keys(statusCounts),
                        values: Object.values(statusCounts),
                        type: 'pie',
                        hole: 0.3,
                        marker: { colors: ['#28a745', '#dc3545', '#ffc107', '#17a2b8'] }
                    }],
                    layout: {
                        title: 'Filtered Workflow Status Distribution',
                        height: 400,
                        showlegend: true
                    }
                };
                Plotly.newPlot('status-chart', statusChart.data, statusChart.layout, {responsive: true});
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading-spinner').style.display = 'block';
            document.body.classList.add('loading');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').style.display = 'none';
            document.body.classList.remove('loading');
        }

        function toggleCollapsible(contentId) {
            const content = document.getElementById(contentId);
            const button = content.previousElementSibling;
            
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                button.classList.remove('active');
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                button.classList.add('active');
            }
        }

        // Main action functions
        async function refreshData() {
            showLoading();
            try {
                await loadAnomalies();
                if (filteredData) {
                    await applyFilters();
                } else {
                    location.reload();
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                hideLoading();
            }
        }

        async function collectData() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üìä Collecting...';
            button.disabled = true;
            
            try {
                await fetch('/api/collect', { method: 'POST' });
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } catch (error) {
                console.error('Collection failed:', error);
                button.textContent = originalText;
                button.disabled = false;
            }
        }
    </script>
</body>
</html> 