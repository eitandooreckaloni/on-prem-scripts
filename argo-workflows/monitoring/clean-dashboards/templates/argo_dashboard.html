<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Workflows & Tasks Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .connection-test {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-test h2 {
            margin-bottom: 1rem;
            color: #333;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .connection-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border-left: 3px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            line-height: 1;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-success { color: #28a745; }
        .stat-danger { color: #dc3545; }
        .stat-warning { color: #ffc107; }
        .stat-info { color: #17a2b8; }

        .workflows-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header h2 {
            margin: 0;
        }

        .workflows-table {
            width: 100%;
            border-collapse: collapse;
        }

        .workflows-table th,
        .workflows-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .workflows-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .workflows-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-succeeded {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-deleted {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px dashed #bee5eb;
        }

        .deleted-row {
            opacity: 0.7;
            font-style: italic;
        }

        .refresh-btn {
            background: #28a745;
            margin-left: 1rem;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .error-message {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .chart-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .chart-controls {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
        }

        .filter-checkboxes {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .chart-container {
            padding: 2rem;
            height: 400px;
            position: relative;
        }

        .smart-table-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .smart-controls {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: start;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .control-group select, .control-group input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .multi-select-container {
            position: relative;
        }

        .multi-select-header {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 38px;
        }

        .multi-select-header:hover {
            border-color: #007bff;
        }

        .multi-select-header.active {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            border-bottom: 1px solid #f8f9fa;
        }

        .multi-select-option:hover {
            background: #f8f9fa;
        }

        .multi-select-option input[type="checkbox"] {
            margin: 0;
        }

        .multi-select-actions {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
        }

        .multi-select-actions button {
            padding: 0.25rem 0.5rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .multi-select-actions button:hover {
            background: #f8f9fa;
        }

        .selected-count {
            color: #007bff;
            font-weight: 600;
        }

        .filter-indicator {
            background: #007bff;
            color: white;
            border-radius: 10px;
            padding: 0.1rem 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-toggle button {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .view-toggle button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .smart-table-container {
            max-height: 65vh;
            overflow-y: auto;
            min-height: 400px;
        }

        .smart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .smart-table th,
        .smart-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .smart-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .smart-table tr:hover {
            background: #f8f9fa;
        }

        .task-row {
            background: #f9f9f9;
        }

        .task-row td:first-child {
            padding-left: 2rem;
            font-style: italic;
        }

        .type-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .type-workflow {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-task {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .smart-chart-container {
            padding: 2rem;
            height: 60vh;
            min-height: 450px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔍 Smart Workflows & Tasks Analysis</h1>
        <p>Advanced filtering and performance analysis of workflows and individual tasks</p>
    </div>

    <div class="container">
        <!-- Compact Header Section -->
        <div class="header-controls" style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 2rem; background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); align-items: start;">
            <!-- Connection Test - Compact -->
            <div class="connection-test-compact">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #495057;">🔗 Connection</h3>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button id="testConnection" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Test</button>
                    <button id="refreshData" class="btn refresh-btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Refresh</button>
                </div>
                <div id="connectionStatus" class="connection-status" style="font-size: 0.85rem;"></div>
            </div>
            
            <!-- Filtered Results Statistics -->
            <div class="filtered-stats-section">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #495057;">📊 Filtered Results</h3>
                <div class="stats-grid-compact" id="filteredStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                    <!-- Filtered stats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Main Analysis Section -->
        <div class="smart-table-section" style="margin-bottom: 2rem; min-height: 70vh;">
            <div class="smart-controls">
                <div class="control-group">
                    <label>View Type:</label>
                    <div class="view-toggle">
                        <button id="chartViewBtn" class="active" onclick="switchView('chart')">Performance Chart</button>
                        <button id="tableViewBtn" onclick="switchView('table')">Table View</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Show:</label>
                    <select id="itemTypeFilter" onchange="updateSmartView()">
                        <option value="all">All Items</option>
                        <option value="workflows">Workflows Only</option>
                        <option value="tasks">Tasks Only</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Workflow Type:</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('workflowType')">
                            <span id="workflowTypeDisplay">All Types</span>
                            <span>▼</span>
                        </div>
                        <div id="workflowTypeDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('workflowType')">Select All</button>
                                <button onclick="clearAllFilter('workflowType')">Clear All</button>
                            </div>
                            <div id="workflowTypeOptions">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label>Task Type:</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('taskType')">
                            <span id="taskTypeDisplay">All Tasks</span>
                            <span>▼</span>
                        </div>
                        <div id="taskTypeDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('taskType')">Select All</button>
                                <button onclick="clearAllFilter('taskType')">Clear All</button>
                            </div>
                            <div id="taskTypeOptions">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label>Status:</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('status')">
                            <span id="statusDisplay">All Statuses</span>
                            <span>▼</span>
                        </div>
                        <div id="statusDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('status')">Select All</button>
                                <button onclick="clearAllFilter('status')">Clear All</button>
                            </div>
                            <div id="statusOptions">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="status_Succeeded" value="Succeeded" onchange="updateMultiSelectFilter('status')">
                                    <label for="status_Succeeded">Succeeded</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="status_Failed" value="Failed" onchange="updateMultiSelectFilter('status')">
                                    <label for="status_Failed">Failed</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="status_Running" value="Running" onchange="updateMultiSelectFilter('status')">
                                    <label for="status_Running">Running</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="status_deleted" value="deleted" onchange="updateMultiSelectFilter('status')">
                                    <label for="status_deleted">Deleted</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label>Search:</label>
                    <input type="text" id="searchFilter" placeholder="Search names..." onkeyup="updateSmartView()">
                </div>
                <div class="control-group" id="chartControls" style="display: none;">
                    <label>Reference Lines:</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.85rem;">
                            <input type="checkbox" id="showAverageLines" onchange="updateSmartView()">
                            Average
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.85rem;">
                            <input type="checkbox" id="showMedianLines" onchange="updateSmartView()">
                            Median
                        </label>
                    </div>
                </div>
            </div>
            <div id="smartTableView" class="smart-table-container">
                <div class="loading">Loading smart analysis...</div>
            </div>
            <div id="smartChartView" class="smart-chart-container" style="display: none;">
                <canvas id="smartChart"></canvas>
            </div>
        </div>

        <!-- Recent Workflows Summary - Minimal -->
        <div class="workflows-section" style="background: #f8f9fa; border-radius: 6px; padding: 1rem; margin-top: 1rem; max-height: 400px; overflow: hidden;">
            <div class="section-header" style="background: #f8f9fa; padding: 0.5rem 0; border: none; margin-bottom: 0.5rem; position: sticky; top: 0; z-index: 10;">
                <h4 style="color: #495057; font-size: 1rem; margin: 0;">📋 Recent Workflows</h4>
            </div>
            <div id="workflowsContent" style="font-size: 0.9rem; max-height: 320px; overflow-y: auto;">
                <div class="loading">Loading workflows...</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isLoading = false;
        let smartChart = null;
        let smartData = { workflows: [], tasks: [], summary: {} };
        let currentView = 'chart';
        let multiSelectFilters = {
            workflowType: [],
            taskType: [],
            status: []
        };

        // DOM elements
        const testConnectionBtn = document.getElementById('testConnection');
        const refreshDataBtn = document.getElementById('refreshData');
        const connectionStatus = document.getElementById('connectionStatus');
        const filteredStatsGrid = document.getElementById('filteredStatsGrid');
        const workflowsContent = document.getElementById('workflowsContent');

        // Event listeners
        testConnectionBtn.addEventListener('click', testConnection);
        refreshDataBtn.addEventListener('click', refreshAllData);

        // Test connection function
        async function testConnection() {
            if (isLoading) return;

            isLoading = true;
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'Testing...';

            showConnectionStatus('loading', 'Testing connection to Argo Workflows...');

            try {
                const response = await fetch('/api/test-connection');
                const result = await response.json();

                if (result.status === 'success') {
                    showConnectionStatus('success', `✅ ${result.message}\nNamespace: ${result.namespace}`);
                } else {
                    showConnectionStatus('error', `❌ ${result.message}`);
                }
            } catch (error) {
                showConnectionStatus('error', `❌ Connection failed: ${error.message}`);
            }

            isLoading = false;
            testConnectionBtn.disabled = false;
            testConnectionBtn.textContent = 'Test Connection';
        }

        // Show connection status
        function showConnectionStatus(type, message) {
            connectionStatus.className = `connection-status status-${type}`;
            connectionStatus.innerHTML = message.replace(/\n/g, '<br>');
            connectionStatus.style.display = 'block';
        }

        // Update filtered statistics based on current filter selection
        function updateFilteredStats(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                filteredStatsGrid.innerHTML = '<div class="loading">No data to display</div>';
                return;
            }

            // Calculate stats from filtered data
            const total = filteredData.length;
            const workflows = filteredData.filter(item => item.type === 'workflow');
            const tasks = filteredData.filter(item => item.type === 'task');
            
            const succeeded = filteredData.filter(item => item.status === 'Succeeded').length;
            const failed = filteredData.filter(item => item.status === 'Failed').length;
            const running = filteredData.filter(item => item.status === 'Running').length;
            const deleted = filteredData.filter(item => item.is_deleted).length;
            
            // Calculate average duration for completed items
            const completedItems = filteredData.filter(item => item.duration_seconds !== null && item.duration_seconds !== undefined);
            const avgDuration = completedItems.length > 0 
                ? (completedItems.reduce((sum, item) => sum + item.duration_seconds, 0) / completedItems.length).toFixed(1)
                : 0;

            filteredStatsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number stat-info">${total}</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${workflows.length}</div>
                    <div class="stat-label">Workflows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${tasks.length}</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-success">${succeeded}</div>
                    <div class="stat-label">Succeeded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-danger">${failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-warning">${running}</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${deleted}</div>
                    <div class="stat-label">Deleted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${avgDuration}s</div>
                    <div class="stat-label">Avg Duration</div>
                </div>
            `;
        }

        // Load workflows
        async function loadWorkflows() {
            try {
                const response = await fetch('/api/workflows?limit=15');
                const workflows = await response.json();

                if (workflows.length === 0) {
                    workflowsContent.innerHTML = '<div class="loading">No workflows found</div>';
                    return;
                }

                const tableHTML = `
                    <table class="workflows-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Namespace</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${workflows.map(wf => `
                                <tr class="${wf.is_deleted ? 'deleted-row' : ''}">
                                    <td><strong>${wf.name}</strong></td>
                                    <td><span class="status-badge ${getStatusClass(wf.status)}">${wf.status}</span></td>
                                    <td>${formatTimestamp(wf.created_at)}</td>
                                    <td>${formatTimestamp(wf.started_at)}</td>
                                    <td>${formatDuration(wf.duration_seconds)}</td>
                                    <td>${wf.namespace}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                workflowsContent.innerHTML = tableHTML;
            } catch (error) {
                workflowsContent.innerHTML = '<div class="error-message">Failed to load workflows</div>';
            }
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return `${seconds.toFixed(1)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds.toFixed(0)}s`;
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('deleted')) return 'status-deleted';
            if (statusLower.includes('succeeded')) return 'status-succeeded';
            if (statusLower.includes('failed')) return 'status-failed';
            if (statusLower.includes('running')) return 'status-running';
            return 'status-unknown';
        }

        // Load smart data
        async function loadSmartData() {
            try {
                const response = await fetch('/api/tasks-data?limit=50');
                smartData = await response.json();
                
                // Populate filter dropdowns
                populateFilterDropdowns();
                updateSmartView();
            } catch (error) {
                console.error('Failed to load smart data:', error);
                document.getElementById('smartTableView').innerHTML = '<div class="error-message">Failed to load smart analysis data</div>';
            }
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate workflow types
            const workflowTypeOptions = document.getElementById('workflowTypeOptions');
            workflowTypeOptions.innerHTML = '';
            
            if (smartData.summary.workflow_types) {
                smartData.summary.workflow_types.forEach(type => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multi-select-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="workflowType_${type}" value="${type}" onchange="updateMultiSelectFilter('workflowType')">
                        <label for="workflowType_${type}">${type}</label>
                    `;
                    workflowTypeOptions.appendChild(optionDiv);
                });
            }

            // Populate task types
            const taskTypeOptions = document.getElementById('taskTypeOptions');
            taskTypeOptions.innerHTML = '';
            
            if (smartData.summary.task_types) {
                smartData.summary.task_types.forEach(type => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multi-select-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="taskType_${type}" value="${type}" onchange="updateMultiSelectFilter('taskType')">
                        <label for="taskType_${type}">${type}</label>
                    `;
                    taskTypeOptions.appendChild(optionDiv);
                });
            }

            // Update displays
            updateMultiSelectDisplay('workflowType');
            updateMultiSelectDisplay('taskType');
            updateMultiSelectDisplay('status');
        }

        // Multi-select functions
        function toggleMultiSelect(filterType) {
            const dropdown = document.getElementById(filterType + 'Dropdown');
            const header = dropdown.previousElementSibling;
            
            // Close other dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('show');
                    dd.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('show');
            header.classList.toggle('active');
        }

        function updateMultiSelectFilter(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input[type="checkbox"]`);
            multiSelectFilters[filterType] = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            updateMultiSelectDisplay(filterType);
            updateSmartView();
        }

        function updateMultiSelectDisplay(filterType) {
            const display = document.getElementById(filterType + 'Display');
            const selected = multiSelectFilters[filterType];
            
            if (selected.length === 0) {
                let defaultText = 'All';
                if (filterType === 'workflowType') defaultText = 'All Types';
                else if (filterType === 'taskType') defaultText = 'All Tasks';
                else if (filterType === 'status') defaultText = 'All Statuses';
                display.innerHTML = defaultText;
            } else if (selected.length === 1) {
                display.innerHTML = selected[0];
            } else {
                display.innerHTML = `<span class="selected-count">${selected.length} selected</span>`;
            }
        }

        function selectAllFilter(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = true);
            updateMultiSelectFilter(filterType);
        }

        function clearAllFilter(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = false);
            updateMultiSelectFilter(filterType);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    dropdown.previousElementSibling.classList.remove('active');
                });
            }
        });

        // Switch between table, chart, and timeline view
        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            document.getElementById('chartViewBtn').classList.toggle('active', view === 'chart');
            
            // Show/hide views
            document.getElementById('smartTableView').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('smartChartView').style.display = view === 'chart' ? 'block' : 'none';
            
            // Show/hide chart controls
            document.getElementById('chartControls').style.display = view === 'chart' ? 'block' : 'none';
            
            updateSmartView();
        }

        // Update smart view based on filters
        function updateSmartView() {
            const filteredData = applySmartFilters();
            
            // Update the filtered stats
            updateFilteredStats(filteredData);
            
            if (currentView === 'table') {
                updateSmartTable(filteredData);
            } else if (currentView === 'chart') {
                updateSmartChart(filteredData);
            }
        }

        // Apply filters to smart data
        function applySmartFilters() {
            const itemType = document.getElementById('itemTypeFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();

            let allItems = [];
            
            // Add workflows if needed
            if (itemType === 'all' || itemType === 'workflows') {
                allItems = allItems.concat(smartData.workflows || []);
            }
            
            // Add tasks if needed
            if (itemType === 'all' || itemType === 'tasks') {
                allItems = allItems.concat(smartData.tasks || []);
            }

            // Apply filters
            return allItems.filter(item => {
                // Workflow type filter - if any workflow types are selected, filter by them
                if (multiSelectFilters.workflowType.length > 0) {
                    if (!multiSelectFilters.workflowType.includes(item.workflow_type)) return false;
                }
                
                // Task type filter - if any task types are selected, filter by them (only for tasks)
                if (multiSelectFilters.taskType.length > 0 && item.type === 'task') {
                    if (!multiSelectFilters.taskType.includes(item.task_type)) return false;
                }
                
                // Status filter - if any statuses are selected, filter by them
                if (multiSelectFilters.status.length > 0) {
                    let matchesStatus = false;
                    for (const selectedStatus of multiSelectFilters.status) {
                        if (selectedStatus === 'deleted' && item.is_deleted) {
                            matchesStatus = true;
                            break;
                        }
                        if (selectedStatus !== 'deleted' && item.status.includes(selectedStatus)) {
                            matchesStatus = true;
                            break;
                        }
                    }
                    if (!matchesStatus) return false;
                }
                
                // Search filter
                if (search && !item.name.toLowerCase().includes(search)) return false;
                
                return true;
            });
        }

        // Update smart table
        function updateSmartTable(filteredData) {
            const tableView = document.getElementById('smartTableView');
            
            if (filteredData.length === 0) {
                tableView.innerHTML = '<div class="loading">No items match your filters</div>';
                return;
            }

            const tableHTML = `
                <table class="smart-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Workflow Type</th>
                            <th>Task Type</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Workflow</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => `
                            <tr class="${item.type === 'task' ? 'task-row' : ''}">
                                <td><span class="type-badge type-${item.type}">${item.type.toUpperCase()}</span></td>
                                <td><strong>${item.name}</strong></td>
                                <td><span class="status-badge ${getStatusClass(item.status)}">${item.status}</span></td>
                                <td>${item.workflow_type || '-'}</td>
                                <td>${item.task_type || '-'}</td>
                                <td>${formatTimestamp(item.started_at)}</td>
                                <td>${formatDuration(item.duration_seconds)}</td>
                                <td>${item.workflow_name || item.name}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            tableView.innerHTML = tableHTML;
        }

        // Update smart chart - now shows individual executions as bar chart over time
        function updateSmartChart(filteredData) {
            const chartContainer = document.getElementById('smartChartView');
            const ctx = document.getElementById('smartChart').getContext('2d');
            
            // Ensure chart container is visible before creating chart
            if (currentView === 'chart' && chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            }
            
            if (smartChart) {
                smartChart.destroy();
            }

            // Filter out items without duration or start time
            const validData = filteredData.filter(item => 
                item.started_at && item.duration_seconds !== null && item.duration_seconds !== undefined
            );

            if (validData.length === 0) {
                const emptyChart = new Chart(ctx, {
                    type: 'bar',
                    data: { datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Performance Chart - No Data Available'
                            }
                        }
                    }
                });
                smartChart = emptyChart;
                return;
            }

            // Sort data by start time
            validData.sort((a, b) => new Date(a.started_at) - new Date(b.started_at));

            // Group data by type for different colors
            const groups = {};
            validData.forEach(item => {
                const groupKey = item.task_type || item.workflow_type || 'Other';
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                
                groups[groupKey].push({
                    x: new Date(item.started_at),
                    y: item.duration_seconds,
                    name: item.name,
                    status: item.status,
                    workflow_type: item.workflow_type,
                    task_type: item.task_type,
                    type: item.type
                });
            });

            // Create datasets with different colors for each group
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];

            const datasets = [];
            let colorIndex = 0;

            // Get time range for reference lines
            const minTime = Math.min(...validData.map(item => new Date(item.started_at).getTime()));
            const maxTime = Math.max(...validData.map(item => new Date(item.started_at).getTime()));

            // Check if reference lines should be shown
            const showAverageLines = document.getElementById('showAverageLines').checked;
            const showMedianLines = document.getElementById('showMedianLines').checked;

            Object.keys(groups).forEach(groupKey => {
                const color = colors[colorIndex % colors.length];
                const borderColor = color.replace('0.8', '1');
                colorIndex++;

                // Add bar chart dataset for this group
                datasets.push({
                    label: groupKey,
                    data: groups[groupKey],
                    backgroundColor: color,
                    borderColor: borderColor,
                    borderWidth: 1,
                    barThickness: 20,
                    maxBarThickness: 30,
                    type: 'bar'
                });

                // Calculate reference values
                const durations = groups[groupKey].map(item => item.y);
                const average = durations.reduce((sum, d) => sum + d, 0) / durations.length;
                const sortedDurations = [...durations].sort((a, b) => a - b);
                const median = sortedDurations[Math.floor(sortedDurations.length / 2)];

                // Add average line dataset
                if (showAverageLines) {
                    datasets.push({
                        label: `${groupKey} Average`,
                        data: [
                            { x: new Date(minTime), y: average },
                            { x: new Date(maxTime), y: average }
                        ],
                        type: 'line',
                        borderColor: borderColor,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }

                // Add median line dataset
                if (showMedianLines) {
                    datasets.push({
                        label: `${groupKey} Median`,
                        data: [
                            { x: new Date(minTime), y: median },
                            { x: new Date(maxTime), y: median }
                        ],
                        type: 'line',
                        borderColor: borderColor,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }
            });

            // Add a small delay to ensure canvas is properly sized
            setTimeout(() => {
                smartChart = new Chart(ctx, {
                    type: 'bar',
                    data: { datasets },
                    options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            title: {
                                display: true,
                                text: 'Start Time'
                            },
                            time: {
                                displayFormats: {
                                    minute: 'MMM dd HH:mm',
                                    hour: 'MMM dd HH:mm',
                                    day: 'MMM dd, yyyy',
                                    week: 'MMM dd, yyyy',
                                    month: 'MMM yyyy'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Duration (seconds)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Chart - Individual Executions with Reference Lines'
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                // Only show tooltips for bar chart data, not reference lines
                                return tooltipItem.dataset.type === 'bar' || !tooltipItem.dataset.type;
                            },
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('en-US', { 
                                        weekday: 'short', 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    if (point && point.name) {
                                        return [
                                            `${context.dataset.label}: ${formatDuration(point.y)}`,
                                            `Name: ${point.name}`,
                                            `Status: ${point.status}`,
                                            `Type: ${point.type}`,
                                            point.workflow_type ? `Workflow: ${point.workflow_type}` : '',
                                            point.task_type ? `Task: ${point.task_type}` : ''
                                        ].filter(Boolean);
                                    }
                                    return `${context.dataset.label}: ${formatDuration(context.parsed.y)}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                filter: function(legendItem, chartData) {
                                    // Group reference lines in legend
                                    return true;
                                }
                            }
                        }
                    }
                }
            });
            }, 10); // Small delay to ensure canvas is properly rendered
        }

        // Refresh all data
        async function refreshAllData() {
            if (isLoading) return;

            isLoading = true;
            refreshDataBtn.disabled = true;
            refreshDataBtn.textContent = 'Refreshing...';

            await Promise.all([loadWorkflows(), loadSmartData()]);

            isLoading = false;
            refreshDataBtn.disabled = false;
            refreshDataBtn.textContent = 'Refresh Data';
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure initial view state is correct
            switchView('chart');
            refreshAllData();
        });

        // Auto-refresh every 30 seconds
        setInterval(refreshAllData, 30000);
    </script>
</body>
</html> 