<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Workflows & Tasks Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .connection-test {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-test h2 {
            margin-bottom: 1rem;
            color: #333;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .connection-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border-left: 3px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            line-height: 1;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-success { color: #28a745; }
        .stat-danger { color: #dc3545; }
        .stat-warning { color: #ffc107; }
        .stat-info { color: #17a2b8; }

        .workflows-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header h2 {
            margin: 0;
        }

        .workflows-table {
            width: 100%;
            border-collapse: collapse;
        }

        .workflows-table th,
        .workflows-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .workflows-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .workflows-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-succeeded {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-deleted {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px dashed #bee5eb;
        }

        .deleted-row {
            opacity: 0.7;
            font-style: italic;
        }

        .refresh-btn {
            background: #28a745;
            margin-left: 1rem;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .error-message {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .chart-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .chart-controls {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
        }

        .filter-checkboxes {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .chart-container {
            padding: 2rem;
            height: 400px;
            position: relative;
        }

        .smart-table-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .smart-controls {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .control-group select, .control-group input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-toggle button {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .view-toggle button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .smart-table-container {
            max-height: 65vh;
            overflow-y: auto;
            min-height: 400px;
        }

        .smart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .smart-table th,
        .smart-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .smart-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .smart-table tr:hover {
            background: #f8f9fa;
        }

        .task-row {
            background: #f9f9f9;
        }

        .task-row td:first-child {
            padding-left: 2rem;
            font-style: italic;
        }

        .type-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .type-workflow {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-task {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .smart-chart-container {
            padding: 2rem;
            height: 60vh;
            min-height: 450px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Smart Workflows & Tasks Analysis</h1>
        <p>Advanced filtering and performance analysis of workflows and individual tasks</p>
    </div>

    <div class="container">
        <!-- Compact Header Section -->
        <div class="header-controls" style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 2rem; background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); align-items: start;">
            <!-- Connection Test - Compact -->
            <div class="connection-test-compact">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #495057;">üîó Connection</h3>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button id="testConnection" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Test</button>
                    <button id="refreshData" class="btn refresh-btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Refresh</button>
                </div>
                <div id="connectionStatus" class="connection-status" style="font-size: 0.85rem;"></div>
            </div>
            
            <!-- Filtered Results Statistics -->
            <div class="filtered-stats-section">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #495057;">üìä Filtered Results</h3>
                <div class="stats-grid-compact" id="filteredStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                    <!-- Filtered stats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Main Analysis Section -->
        <div class="smart-table-section" style="margin-bottom: 2rem; min-height: 70vh;">
            <div class="smart-controls">
                <div class="control-group">
                    <label>View Type:</label>
                    <div class="view-toggle">
                        <button id="tableViewBtn" class="active" onclick="switchView('table')">Table View</button>
                        <button id="chartViewBtn" onclick="switchView('chart')">Performance Chart</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Show:</label>
                    <select id="itemTypeFilter" onchange="updateSmartView()">
                        <option value="all">All Items</option>
                        <option value="workflows">Workflows Only</option>
                        <option value="tasks">Tasks Only</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Workflow Type:</label>
                    <select id="workflowTypeFilter" onchange="updateSmartView()">
                        <option value="all">All Types</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Task Type:</label>
                    <select id="taskTypeFilter" onchange="updateSmartView()">
                        <option value="all">All Tasks</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Status:</label>
                    <select id="statusFilter" onchange="updateSmartView()">
                        <option value="all">All Statuses</option>
                        <option value="Succeeded">Succeeded</option>
                        <option value="Failed">Failed</option>
                        <option value="Running">Running</option>
                        <option value="deleted">Deleted</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Search:</label>
                    <input type="text" id="searchFilter" placeholder="Search names..." onkeyup="updateSmartView()">
                </div>
            </div>
            <div id="smartTableView" class="smart-table-container">
                <div class="loading">Loading smart analysis...</div>
            </div>
            <div id="smartChartView" class="smart-chart-container" style="display: none;">
                <canvas id="smartChart"></canvas>
            </div>
        </div>

        <!-- Recent Workflows Summary - Minimal -->
        <div class="workflows-section" style="background: #f8f9fa; border-radius: 6px; padding: 1rem; margin-top: 1rem; max-height: 300px; overflow-y: auto;">
            <div class="section-header" style="background: none; padding: 0; border: none; margin-bottom: 1rem;">
                <h4 style="color: #495057; font-size: 1rem; margin: 0;">üìã Recent Workflows</h4>
            </div>
            <div id="workflowsContent" style="font-size: 0.9rem;">
                <div class="loading">Loading workflows...</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isLoading = false;
        let smartChart = null;
        let smartData = { workflows: [], tasks: [], summary: {} };
        let currentView = 'table';

        // DOM elements
        const testConnectionBtn = document.getElementById('testConnection');
        const refreshDataBtn = document.getElementById('refreshData');
        const connectionStatus = document.getElementById('connectionStatus');
        const filteredStatsGrid = document.getElementById('filteredStatsGrid');
        const workflowsContent = document.getElementById('workflowsContent');

        // Event listeners
        testConnectionBtn.addEventListener('click', testConnection);
        refreshDataBtn.addEventListener('click', refreshAllData);

        // Test connection function
        async function testConnection() {
            if (isLoading) return;

            isLoading = true;
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'Testing...';

            showConnectionStatus('loading', 'Testing connection to Argo Workflows...');

            try {
                const response = await fetch('/api/test-connection');
                const result = await response.json();

                if (result.status === 'success') {
                    showConnectionStatus('success', `‚úÖ ${result.message}\nNamespace: ${result.namespace}`);
                } else {
                    showConnectionStatus('error', `‚ùå ${result.message}`);
                }
            } catch (error) {
                showConnectionStatus('error', `‚ùå Connection failed: ${error.message}`);
            }

            isLoading = false;
            testConnectionBtn.disabled = false;
            testConnectionBtn.textContent = 'Test Connection';
        }

        // Show connection status
        function showConnectionStatus(type, message) {
            connectionStatus.className = `connection-status status-${type}`;
            connectionStatus.innerHTML = message.replace(/\n/g, '<br>');
            connectionStatus.style.display = 'block';
        }

        // Update filtered statistics based on current filter selection
        function updateFilteredStats(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                filteredStatsGrid.innerHTML = '<div class="loading">No data to display</div>';
                return;
            }

            // Calculate stats from filtered data
            const total = filteredData.length;
            const workflows = filteredData.filter(item => item.type === 'workflow');
            const tasks = filteredData.filter(item => item.type === 'task');
            
            const succeeded = filteredData.filter(item => item.status === 'Succeeded').length;
            const failed = filteredData.filter(item => item.status === 'Failed').length;
            const running = filteredData.filter(item => item.status === 'Running').length;
            const deleted = filteredData.filter(item => item.is_deleted).length;
            
            // Calculate average duration for completed items
            const completedItems = filteredData.filter(item => item.duration_seconds !== null && item.duration_seconds !== undefined);
            const avgDuration = completedItems.length > 0 
                ? (completedItems.reduce((sum, item) => sum + item.duration_seconds, 0) / completedItems.length).toFixed(1)
                : 0;

            filteredStatsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number stat-info">${total}</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${workflows.length}</div>
                    <div class="stat-label">Workflows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${tasks.length}</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-success">${succeeded}</div>
                    <div class="stat-label">Succeeded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-danger">${failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-warning">${running}</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${deleted}</div>
                    <div class="stat-label">Deleted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-info">${avgDuration}s</div>
                    <div class="stat-label">Avg Duration</div>
                </div>
            `;
        }

        // Load workflows
        async function loadWorkflows() {
            try {
                const response = await fetch('/api/workflows?limit=15');
                const workflows = await response.json();

                if (workflows.length === 0) {
                    workflowsContent.innerHTML = '<div class="loading">No workflows found</div>';
                    return;
                }

                const tableHTML = `
                    <table class="workflows-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Namespace</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${workflows.map(wf => `
                                <tr class="${wf.is_deleted ? 'deleted-row' : ''}">
                                    <td><strong>${wf.name}</strong></td>
                                    <td><span class="status-badge ${getStatusClass(wf.status)}">${wf.status}</span></td>
                                    <td>${formatTimestamp(wf.created_at)}</td>
                                    <td>${formatTimestamp(wf.started_at)}</td>
                                    <td>${formatDuration(wf.duration_seconds)}</td>
                                    <td>${wf.namespace}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                workflowsContent.innerHTML = tableHTML;
            } catch (error) {
                workflowsContent.innerHTML = '<div class="error-message">Failed to load workflows</div>';
            }
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return `${seconds.toFixed(1)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds.toFixed(0)}s`;
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('deleted')) return 'status-deleted';
            if (statusLower.includes('succeeded')) return 'status-succeeded';
            if (statusLower.includes('failed')) return 'status-failed';
            if (statusLower.includes('running')) return 'status-running';
            return 'status-unknown';
        }



        // Load smart data
        async function loadSmartData() {
            try {
                const response = await fetch('/api/tasks-data?limit=50');
                smartData = await response.json();
                
                // Populate filter dropdowns
                populateFilterDropdowns();
                updateSmartView();
            } catch (error) {
                console.error('Failed to load smart data:', error);
                document.getElementById('smartTableView').innerHTML = '<div class="error-message">Failed to load smart analysis data</div>';
            }
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Workflow types
            const workflowTypeFilter = document.getElementById('workflowTypeFilter');
            const currentWorkflowType = workflowTypeFilter.value;
            workflowTypeFilter.innerHTML = '<option value="all">All Types</option>';
            
            if (smartData.summary.workflow_types) {
                smartData.summary.workflow_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    workflowTypeFilter.appendChild(option);
                });
                workflowTypeFilter.value = currentWorkflowType;
            }

            // Task types
            const taskTypeFilter = document.getElementById('taskTypeFilter');
            const currentTaskType = taskTypeFilter.value;
            taskTypeFilter.innerHTML = '<option value="all">All Tasks</option>';
            
            if (smartData.summary.task_types) {
                smartData.summary.task_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    taskTypeFilter.appendChild(option);
                });
                taskTypeFilter.value = currentTaskType;
            }
        }

        // Switch between table and chart view
        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            document.getElementById('chartViewBtn').classList.toggle('active', view === 'chart');
            
            // Show/hide views
            document.getElementById('smartTableView').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('smartChartView').style.display = view === 'chart' ? 'block' : 'none';
            
            updateSmartView();
        }

        // Update smart view based on filters
        function updateSmartView() {
            const filteredData = applySmartFilters();
            
            // Update the filtered stats
            updateFilteredStats(filteredData);
            
            if (currentView === 'table') {
                updateSmartTable(filteredData);
            } else if (currentView === 'chart') {
                updateSmartChart(filteredData);
            }
        }

        // Apply filters to smart data
        function applySmartFilters() {
            const itemType = document.getElementById('itemTypeFilter').value;
            const workflowType = document.getElementById('workflowTypeFilter').value;
            const taskType = document.getElementById('taskTypeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();

            let allItems = [];
            
            // Add workflows if needed
            if (itemType === 'all' || itemType === 'workflows') {
                allItems = allItems.concat(smartData.workflows || []);
            }
            
            // Add tasks if needed
            if (itemType === 'all' || itemType === 'tasks') {
                allItems = allItems.concat(smartData.tasks || []);
            }

            // Apply filters
            return allItems.filter(item => {
                // Workflow type filter
                if (workflowType !== 'all' && item.workflow_type !== workflowType) return false;
                
                // Task type filter (only for tasks)
                if (taskType !== 'all' && item.type === 'task' && item.task_type !== taskType) return false;
                
                // Status filter
                if (status !== 'all') {
                    if (status === 'deleted' && !item.is_deleted) return false;
                    if (status !== 'deleted' && !item.status.includes(status)) return false;
                }
                
                // Search filter
                if (search && !item.name.toLowerCase().includes(search)) return false;
                
                return true;
            });
        }

        // Update smart table
        function updateSmartTable(filteredData) {
            const tableView = document.getElementById('smartTableView');
            
            if (filteredData.length === 0) {
                tableView.innerHTML = '<div class="loading">No items match your filters</div>';
                return;
            }

            const tableHTML = `
                <table class="smart-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Workflow Type</th>
                            <th>Task Type</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Workflow</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => `
                            <tr class="${item.type === 'task' ? 'task-row' : ''}">
                                <td><span class="type-badge type-${item.type}">${item.type.toUpperCase()}</span></td>
                                <td><strong>${item.name}</strong></td>
                                <td><span class="status-badge ${getStatusClass(item.status)}">${item.status}</span></td>
                                <td>${item.workflow_type || '-'}</td>
                                <td>${item.task_type || '-'}</td>
                                <td>${formatTimestamp(item.started_at)}</td>
                                <td>${formatDuration(item.duration_seconds)}</td>
                                <td>${item.workflow_name || item.name}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            tableView.innerHTML = tableHTML;
        }

        // Update smart chart - now shows individual executions over time
        function updateSmartChart(filteredData) {
            const ctx = document.getElementById('smartChart').getContext('2d');
            
            if (smartChart) {
                smartChart.destroy();
            }

            // Filter out items without duration or start time
            const validData = filteredData.filter(item => 
                item.started_at && item.duration_seconds !== null && item.duration_seconds !== undefined
            );

            if (validData.length === 0) {
                const emptyChart = new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Performance Chart - No Data Available'
                            }
                        }
                    }
                });
                smartChart = emptyChart;
                return;
            }

            // Group data by type for different colors
            const groups = {};
            validData.forEach(item => {
                const groupKey = item.task_type || item.workflow_type || 'Other';
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                
                groups[groupKey].push({
                    x: new Date(item.started_at),
                    y: item.duration_seconds,
                    name: item.name,
                    status: item.status,
                    workflow_type: item.workflow_type,
                    task_type: item.task_type,
                    type: item.type
                });
            });

            // Sort each group by time
            Object.keys(groups).forEach(key => {
                groups[key].sort((a, b) => a.x - b.x);
            });

            // Create datasets with different colors for each group
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];

            const datasets = [];
            let colorIndex = 0;

            Object.keys(groups).forEach(groupKey => {
                const color = colors[colorIndex % colors.length];
                colorIndex++;

                datasets.push({
                    label: groupKey,
                    data: groups[groupKey],
                    backgroundColor: color,
                    borderColor: color.replace('0.8', '1'),
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            });

            smartChart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    },
                                         scales: {
                         x: {
                             type: 'time',
                             title: {
                                 display: true,
                                 text: 'Start Time'
                             }
                         },
                        y: {
                            title: {
                                display: true,
                                text: 'Duration (seconds)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Chart - Individual Executions Over Time'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString();
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `${context.dataset.label}: ${formatDuration(point.y)}`,
                                        `Name: ${point.name}`,
                                        `Status: ${point.status}`,
                                        `Type: ${point.type}`,
                                        point.workflow_type ? `Workflow: ${point.workflow_type}` : '',
                                        point.task_type ? `Task: ${point.task_type}` : ''
                                    ].filter(Boolean);
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
                }

        // Refresh all data
        async function refreshAllData() {
            if (isLoading) return;

            isLoading = true;
            refreshDataBtn.disabled = true;
            refreshDataBtn.textContent = 'Refreshing...';

            await Promise.all([loadWorkflows(), loadSmartData()]);

            isLoading = false;
            refreshDataBtn.disabled = false;
            refreshDataBtn.textContent = 'Refresh Data';
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            refreshAllData();
        });

        // Auto-refresh every 30 seconds
        setInterval(refreshAllData, 30000);
    </script>
</body>
</html> 