<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinai Workflows Dashboard - Powered by Argo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            /* Official Argo Color Palette */
            --argo-navy: #4c5866;
            --argo-navy-dark: #3a434e;
            --argo-navy-light: #6b7785;
            --argo-orange: #ff6633;
            --argo-orange-dark: #e55a2b;
            --argo-orange-light: #ff8566;
            --argo-orange-bg: #fff4f0;
            --argo-navy-bg: #f4f5f7;
            
            /* Status Colors */
            --status-success: #28a745;
            --status-success-bg: #d4edda;
            --status-error: #dc3545;
            --status-error-bg: #f8d7da;
            --status-warning: #ffc107;
            --status-warning-bg: #fff3cd;
            --status-info: #17a2b8;
            --status-info-bg: #d1ecf1;
            
            /* Neutral Colors */
            --gray-50: #fafafb;
            --gray-100: #f4f5f7;
            --gray-200: #e4e7ea;
            --gray-300: #d1d5da;
            --gray-400: #959da5;
            --gray-500: #6a737d;
            --gray-600: #586069;
            --gray-700: #444d56;
            --gray-800: #2f363d;
            --gray-900: #24292e;
            
            /* Surface Colors */
            --surface-1: #ffffff;
            --surface-2: var(--gray-50);
            --surface-3: var(--gray-100);
            --border-color: var(--gray-200);
            
            /* Text Colors */
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-700);
            --text-tertiary: var(--gray-500);
            
            /* Shadows */
            --shadow-sm: 0 1px 3px 0 rgba(76, 88, 102, 0.1), 0 1px 2px 0 rgba(76, 88, 102, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(76, 88, 102, 0.1), 0 2px 4px -1px rgba(76, 88, 102, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(76, 88, 102, 0.1), 0 4px 6px -2px rgba(76, 88, 102, 0.05);
            
            /* Border Radius */
            --border-radius: 6px;
            --border-radius-lg: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--surface-2);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Argo-style Navigation Bar */
        .navbar {
            background: var(--surface-1);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-content {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .argo-logo {
            width: 32px;
            height: 32px;
            background: var(--argo-navy);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .argo-logo::before {
            content: 'argo';
            font-size: 10px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .argo-logo::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: var(--argo-orange);
            border-radius: 50%;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .brand-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .brand-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
        }

        .status-indicator.connected {
            background: var(--status-success-bg);
            color: var(--status-success);
        }

        .status-indicator.disconnected {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .status-indicator.pending {
            background: var(--argo-orange-bg);
            color: var(--argo-orange);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Argo-style Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            white-space: nowrap;
            user-select: none;
            outline: none;
        }

        .btn:focus-visible {
            outline: 2px solid var(--argo-orange);
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--argo-orange);
            color: white;
            border-color: var(--argo-orange);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--argo-orange-dark);
            border-color: var(--argo-orange-dark);
        }

        .btn-secondary {
            background: var(--surface-1);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-3);
            border-color: var(--argo-gray-300);
        }

        .btn-success {
            background: var(--status-success);
            color: white;
            border-color: var(--status-success);
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            border-color: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-icon {
            padding: 8px;
            min-width: 40px;
            justify-content: center;
        }

        /* Argo-style Cards and Surfaces */
        .card {
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-2);
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
        }

        .card-content {
            padding: 24px;
        }

        .card-actions {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--surface-2);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Status and Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            margin: 16px 0;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: var(--status-success-bg);
            color: var(--status-success);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .alert-danger {
            background: var(--status-error-bg);
            color: var(--status-error);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .alert-warning {
            background: var(--status-warning-bg);
            color: var(--status-warning);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .alert-info {
            background: var(--status-info-bg);
            color: var(--status-info);
            border: 1px solid rgba(23, 162, 184, 0.2);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px 16px;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--argo-gray-300);
            transition: background 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .stat-card.success::before { background: var(--status-success); }
        .stat-card.danger::before { background: var(--status-error); }
        .stat-card.warning::before { background: var(--status-warning); }
        .stat-card.info::before { background: var(--argo-navy); }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 24px;
            height: 24px;
            opacity: 0.3;
            color: var(--text-tertiary);
        }

        /* Argo-style Tables */
        .table-container {
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--surface-2);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th:first-child {
            padding-left: 24px;
        }

        .data-table td:first-child {
            padding-left: 24px;
        }

        .data-table tbody tr {
            transition: background-color 0.15s ease;
        }

        .data-table tbody tr:hover {
            background: var(--surface-2);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Argo-style Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            flex-shrink: 0;
        }

        .status-succeeded {
            background: var(--status-success-bg);
            color: var(--status-success);
        }

        .status-failed {
            background: var(--status-error-bg);
            color: var(--status-error);
        }

        .status-running {
            background: var(--status-info-bg);
            color: var(--status-info);
        }

        .status-pending {
            background: var(--status-warning-bg);
            color: var(--status-warning);
        }

        .status-unknown {
            background: var(--argo-gray-100);
            color: var(--text-secondary);
        }

        .status-deleted {
            background: var(--argo-gray-100);
            color: var(--text-tertiary);
            border: 1px dashed var(--border-color);
        }

        .status-deleted::before {
            background: var(--text-tertiary);
        }

        .deleted-row {
            opacity: 0.6;
            color: var(--text-tertiary) !important;
        }
        
        .deleted-row td {
            color: var(--text-tertiary) !important;
        }

        /* Loading and Empty States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading::before {
            content: '';
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--argo-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-description {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 320px;
        }

        /* Argo-style Form Controls */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            background: var(--surface-1);
            color: var(--text-primary);
            transition: all 0.15s ease;
            outline: none;
        }

        .form-control:focus {
            border-color: var(--argo-navy);
            box-shadow: 0 0 0 3px rgba(76, 88, 102, 0.1);
        }

        .form-control:disabled {
            background: var(--surface-3);
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Filters and Controls Panel */
        .filters-panel {
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .filters-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filters-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .filters-content {
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: start;
        }

        .chart-container {
            padding: 24px;
            height: 400px;
            position: relative;
        }

        .main-section {
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
            overflow: hidden;
        }

        /* Argo-style Multi-Select Dropdown */
        .multi-select-container {
            position: relative;
        }

        .multi-select-header {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--surface-1);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 38px;
            transition: all 0.15s ease;
            outline: none;
        }

        .multi-select-header:hover {
            border-color: var(--argo-navy);
        }

        .multi-select-header.active {
            border-color: var(--argo-navy);
            box-shadow: 0 0 0 3px rgba(76, 88, 102, 0.1);
        }

        .multi-select-display {
            color: var(--text-primary);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .multi-select-arrow {
            color: var(--text-tertiary);
            font-size: 12px;
            transition: transform 0.15s ease;
        }

        .multi-select-header.active .multi-select-arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow-md);
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-actions {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            background: var(--surface-2);
        }

        .multi-select-actions button {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            background: var(--surface-1);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .multi-select-actions button:hover {
            background: var(--surface-3);
            color: var(--text-primary);
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            border-bottom: 1px solid var(--surface-2);
            user-select: none;
            transition: background-color 0.15s ease;
        }

        .multi-select-option:hover {
            background: var(--surface-2);
        }

        .multi-select-option:last-child {
            border-bottom: none;
        }

        .multi-select-option-checkbox {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
            pointer-events: none;
        }

        .multi-select-option-label {
            flex: 1;
            color: var(--text-primary);
            cursor: pointer;
            pointer-events: none;
        }

        .selected-count {
            color: var(--argo-orange);
            font-weight: 600;
        }

        .filter-badge {
            background: var(--argo-orange);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* Argo-style Toggle Buttons */
        .toggle-group {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .toggle-button {
            padding: 8px 16px;
            border: none;
            background: var(--surface-1);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            border-right: 1px solid var(--border-color);
        }

        .toggle-button:last-child {
            border-right: none;
        }

        .toggle-button:hover {
            background: var(--surface-2);
            color: var(--text-primary);
        }

        .toggle-button.active {
            background: var(--argo-orange);
            color: white;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
        }

        .task-row {
            background: var(--surface-2);
        }

        .task-row td:first-child {
            padding-left: 40px;
            position: relative;
        }

        .task-row td:first-child::before {
            content: '';
            position: absolute;
            left: 28px;
            top: 50%;
            width: 8px;
            height: 2px;
            background: var(--border-color);
            transform: translateY(-50%);
        }

        /* Type badges */
        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-workflow {
            background: var(--argo-navy-bg);
            color: var(--argo-navy);
        }

        .type-task {
            background: var(--argo-orange-bg);
            color: var(--argo-orange);
        }

        .chart-wrapper {
            padding: 24px;
            height: 500px;
            position: relative;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar-content {
                padding: 0 16px;
            }
            
            .container {
                padding: 16px;
            }
            
            .filters-content {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .brand-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Argo-style Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="#" class="navbar-brand">
                <div class="argo-logo"></div>
                <div class="brand-text">
                    <div class="brand-title">Sinai Workflows</div>
                    <div class="brand-subtitle">Powered by Argo</div>
                </div>
            </a>
            <div class="navbar-actions">
                <div id="connectionIndicator" class="status-indicator pending">
                    <div class="status-dot"></div>
                    <span>Checking...</span>
                </div>
                <button id="testConnection" class="btn btn-secondary btn-icon" title="Test Connection">
                    <span class="material-icons" style="font-size: 18px;">wifi_protected_setup</span>
                </button>
                <button id="refreshData" class="btn btn-primary btn-icon" title="Refresh Data">
                    <span class="material-icons" style="font-size: 18px;">refresh</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Connection Status Alert -->
        <div id="connectionAlert" class="alert"></div>

        <!-- Statistics Overview -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="material-icons" style="font-size: 20px; margin-right: 8px; vertical-align: text-bottom;">dashboard</span>
                    Overview
                </h2>
            </div>
            <div class="card-content">
                <div class="stats-grid" id="filteredStatsGrid">
                    <!-- Filtered stats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Filters Panel -->
        <div class="filters-panel">
            <div class="filters-header">
                <h3 class="filters-title">
                    <span class="material-icons" style="font-size: 18px; margin-right: 8px; vertical-align: text-bottom;">tune</span>
                    Filters & Controls
                </h3>
                <div class="toggle-group">
                    <button id="chartViewBtn" class="toggle-button active" onclick="switchView('chart')">
                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">analytics</span>
                        Chart
                    </button>
                    <button id="tableViewBtn" class="toggle-button" onclick="switchView('table')">
                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">table_view</span>
                        Table
                    </button>
                </div>
            </div>
            <div class="filters-content">
                <div class="form-group">
                    <label class="form-label">Show Items</label>
                    <select id="itemTypeFilter" class="form-control" onchange="updateSmartView()">
                        <option value="all">All Items</option>
                        <option value="workflows">Workflows Only</option>
                        <option value="tasks">Tasks Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Workflow Type</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('workflowType')">
                            <span id="workflowTypeDisplay" class="multi-select-display">All Types</span>
                            <span class="multi-select-arrow">▼</span>
                        </div>
                        <div id="workflowTypeDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('workflowType')">Select All</button>
                                <button onclick="clearAllFilter('workflowType')">Clear All</button>
                            </div>
                            <div id="workflowTypeOptions">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Task Type</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('taskType')">
                            <span id="taskTypeDisplay" class="multi-select-display">All Tasks</span>
                            <span class="multi-select-arrow">▼</span>
                        </div>
                        <div id="taskTypeDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('taskType')">Select All</button>
                                <button onclick="clearAllFilter('taskType')">Clear All</button>
                            </div>
                            <div id="taskTypeOptions">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('status')">
                            <span id="statusDisplay" class="multi-select-display">All Statuses</span>
                            <span class="multi-select-arrow">▼</span>
                        </div>
                        <div id="statusDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('status')">Select All</button>
                                <button onclick="clearAllFilter('status')">Clear All</button>
                            </div>
                            <div id="statusOptions">
                                <div class="multi-select-option" onclick="toggleFilterOption('status', 'Succeeded')">
                                    <input type="checkbox" class="multi-select-option-checkbox" id="status_Succeeded" value="Succeeded">
                                    <span class="multi-select-option-label">Succeeded</span>
                                </div>
                                <div class="multi-select-option" onclick="toggleFilterOption('status', 'Failed')">
                                    <input type="checkbox" class="multi-select-option-checkbox" id="status_Failed" value="Failed">
                                    <span class="multi-select-option-label">Failed</span>
                                </div>
                                <div class="multi-select-option" onclick="toggleFilterOption('status', 'Running')">
                                    <input type="checkbox" class="multi-select-option-checkbox" id="status_Running" value="Running">
                                    <span class="multi-select-option-label">Running</span>
                                </div>
                                <div class="multi-select-option" onclick="toggleFilterOption('status', 'deleted')">
                                    <input type="checkbox" class="multi-select-option-checkbox" id="status_deleted" value="deleted">
                                    <span class="multi-select-option-label">Deleted</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Namespace</label>
                    <div class="multi-select-container">
                        <div class="multi-select-header" onclick="toggleMultiSelect('namespace')">
                            <span id="namespaceDisplay" class="multi-select-display">All Namespaces</span>
                            <span class="multi-select-arrow">▼</span>
                        </div>
                        <div id="namespaceDropdown" class="multi-select-dropdown">
                            <div class="multi-select-actions">
                                <button onclick="selectAllFilter('namespace')">Select All</button>
                                <button onclick="clearAllFilter('namespace')">Clear All</button>
                            </div>
                            <div id="namespaceOptions">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Search Names</label>
                    <input type="text" id="searchFilter" class="form-control" placeholder="Type to search..." onkeyup="updateSmartView()">
                </div>
                <div class="form-group" id="chartControls" style="display: none;">
                    <label class="form-label">Chart Options</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="checkbox-group">
                            <input type="checkbox" id="showAverageLines" onchange="updateSmartView()">
                            Show Average Lines
                        </label>
                        <label class="checkbox-group">
                            <input type="checkbox" id="showMedianLines" onchange="updateSmartView()">
                            Show Median Lines
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Data Section -->
        <div class="main-section">
            <div class="table-header">
                <h2 class="table-title">
                    <span class="material-icons" style="font-size: 20px; margin-right: 8px; vertical-align: text-bottom;">account_tree</span>
                    Workflows & Tasks Analysis
                </h2>
            </div>
            <div id="smartTableView" class="table-wrapper">
                <div class="loading">Loading analysis data...</div>
            </div>
            <div id="smartChartView" class="chart-wrapper" style="display: none;">
                <canvas id="smartChart"></canvas>
            </div>
        </div>


    </div>

    <script>
        // Global state
        let isLoading = false;
        let smartChart = null;
        let smartData = { workflows: [], tasks: [], summary: {} };
        let currentView = 'chart';
        let multiSelectFilters = {
            workflowType: [],
            taskType: [],
            status: [],
            namespace: []
        };

        // DOM elements
        const testConnectionBtn = document.getElementById('testConnection');
        const refreshDataBtn = document.getElementById('refreshData');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const connectionAlert = document.getElementById('connectionAlert');
        const filteredStatsGrid = document.getElementById('filteredStatsGrid');

        // Event listeners
        testConnectionBtn.addEventListener('click', testConnection);
        refreshDataBtn.addEventListener('click', refreshAllData);

        // Test connection function
        async function testConnection() {
            if (isLoading) return;

            isLoading = true;
            testConnectionBtn.disabled = true;
            updateConnectionStatus('pending', 'Testing...');
            showConnectionAlert('info', 'Testing connection to Argo Workflows...');

            try {
                const response = await fetch('/api/test-connection');
                const result = await response.json();

                if (result.status === 'success') {
                    updateConnectionStatus('connected', 'Connected');
                    showConnectionAlert('success', `Successfully connected to Argo Workflows in namespace: ${result.namespace}`);
                } else {
                    updateConnectionStatus('disconnected', 'Failed');
                    showConnectionAlert('danger', `Connection failed: ${result.message}`);
                }
            } catch (error) {
                updateConnectionStatus('disconnected', 'Error');
                showConnectionAlert('danger', `Connection error: ${error.message}`);
            }

            isLoading = false;
            testConnectionBtn.disabled = false;
        }

        // Update connection status indicator
        function updateConnectionStatus(status, text) {
            connectionIndicator.className = `status-indicator ${status}`;
            connectionIndicator.querySelector('span').textContent = text;
        }

        // Show connection alert
        function showConnectionAlert(type, message) {
            connectionAlert.className = `alert alert-${type} show`;
            connectionAlert.textContent = message;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    connectionAlert.classList.remove('show');
                }, 5000);
            }
        }

        // Update filtered statistics based on current filter selection
        function updateFilteredStats(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                filteredStatsGrid.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">info</span>
                        <div class="empty-state-title">No Data Available</div>
                        <div class="empty-state-description">No items match your current filters or no data has been loaded yet.</div>
                    </div>
                `;
                return;
            }

            // Calculate stats from filtered data
            const total = filteredData.length;
            const workflows = filteredData.filter(item => item.type === 'workflow');
            const tasks = filteredData.filter(item => item.type === 'task');
            
            const succeeded = filteredData.filter(item => item.status === 'Succeeded').length;
            const failed = filteredData.filter(item => item.status === 'Failed').length;
            const running = filteredData.filter(item => item.status === 'Running').length;
            const deleted = filteredData.filter(item => item.is_deleted).length;
            
            // Calculate average duration for completed items
            const completedItems = filteredData.filter(item => item.duration_seconds !== null && item.duration_seconds !== undefined);
            const avgDuration = completedItems.length > 0 
                ? (completedItems.reduce((sum, item) => sum + item.duration_seconds, 0) / completedItems.length).toFixed(1)
                : 0;

            filteredStatsGrid.innerHTML = `
                <div class="stat-card info">
                    <span class="material-icons stat-icon">article</span>
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card info">
                    <span class="material-icons stat-icon">account_tree</span>
                    <div class="stat-number">${workflows.length}</div>
                    <div class="stat-label">Workflows</div>
                </div>
                <div class="stat-card info">
                    <span class="material-icons stat-icon">task</span>
                    <div class="stat-number">${tasks.length}</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-card success">
                    <span class="material-icons stat-icon">check_circle</span>
                    <div class="stat-number">${succeeded}</div>
                    <div class="stat-label">Succeeded</div>
                </div>
                <div class="stat-card danger">
                    <span class="material-icons stat-icon">error</span>
                    <div class="stat-number">${failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card warning">
                    <span class="material-icons stat-icon">play_circle</span>
                    <div class="stat-number">${running}</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-card info">
                    <span class="material-icons stat-icon">delete</span>
                    <div class="stat-number">${deleted}</div>
                    <div class="stat-label">Deleted</div>
                </div>
                <div class="stat-card info">
                    <span class="material-icons stat-icon">schedule</span>
                    <div class="stat-number">${avgDuration}s</div>
                    <div class="stat-label">Avg Duration</div>
                </div>
            `;
        }



        // Utility functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return `${seconds.toFixed(1)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds.toFixed(0)}s`;
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('deleted')) return 'status-deleted';
            if (statusLower.includes('succeeded')) return 'status-succeeded';
            if (statusLower.includes('failed')) return 'status-failed';
            if (statusLower.includes('running')) return 'status-running';
            return 'status-unknown';
        }

        // Load smart data
        async function loadSmartData() {
            try {
                const response = await fetch('/api/tasks-data?limit=50');
                smartData = await response.json();
                
                // Populate filter dropdowns
                populateFilterDropdowns();
                updateSmartView();
            } catch (error) {
                console.error('Failed to load smart data:', error);
                document.getElementById('smartTableView').innerHTML = '<div class="error-message">Failed to load smart analysis data</div>';
            }
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate workflow types
            const workflowTypeOptions = document.getElementById('workflowTypeOptions');
            workflowTypeOptions.innerHTML = '';
            
            if (smartData.summary.workflow_types) {
                smartData.summary.workflow_types.forEach(type => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multi-select-option';
                    optionDiv.onclick = () => toggleFilterOption('workflowType', type);
                    optionDiv.innerHTML = `
                        <input type="checkbox" class="multi-select-option-checkbox" id="workflowType_${type}" value="${type}">
                        <span class="multi-select-option-label">${type}</span>
                    `;
                    workflowTypeOptions.appendChild(optionDiv);
                });
            }

            // Populate task types
            const taskTypeOptions = document.getElementById('taskTypeOptions');
            taskTypeOptions.innerHTML = '';
            
            if (smartData.summary.task_types) {
                smartData.summary.task_types.forEach(type => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multi-select-option';
                    optionDiv.onclick = () => toggleFilterOption('taskType', type);
                    optionDiv.innerHTML = `
                        <input type="checkbox" class="multi-select-option-checkbox" id="taskType_${type}" value="${type}">
                        <span class="multi-select-option-label">${type}</span>
                    `;
                    taskTypeOptions.appendChild(optionDiv);
                });
            }

            // Populate namespaces
            const namespaceOptions = document.getElementById('namespaceOptions');
            namespaceOptions.innerHTML = '';
            
            // Collect unique namespaces from all items
            const namespaces = new Set();
            if (smartData.workflows) {
                smartData.workflows.forEach(wf => {
                    if (wf.namespace) namespaces.add(wf.namespace);
                });
            }
            if (smartData.tasks) {
                smartData.tasks.forEach(task => {
                    if (task.namespace) namespaces.add(task.namespace);
                });
            }
            
            Array.from(namespaces).sort().forEach(namespace => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.onclick = () => toggleFilterOption('namespace', namespace);
                optionDiv.innerHTML = `
                    <input type="checkbox" class="multi-select-option-checkbox" id="namespace_${namespace}" value="${namespace}">
                    <span class="multi-select-option-label">${namespace}</span>
                `;
                namespaceOptions.appendChild(optionDiv);
            });

            // Update displays
            updateMultiSelectDisplay('workflowType');
            updateMultiSelectDisplay('taskType');
            updateMultiSelectDisplay('status');
            updateMultiSelectDisplay('namespace');
        }

        // Multi-select functions
        function toggleMultiSelect(filterType) {
            const dropdown = document.getElementById(filterType + 'Dropdown');
            const header = dropdown.previousElementSibling;
            
            // Close other dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('show');
                    dd.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('show');
            header.classList.toggle('active');
        }

        function updateMultiSelectFilter(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input[type="checkbox"]`);
            multiSelectFilters[filterType] = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            updateMultiSelectDisplay(filterType);
            updateSmartView();
        }

        function updateMultiSelectDisplay(filterType) {
            const display = document.getElementById(filterType + 'Display');
            const selected = multiSelectFilters[filterType];
            
            if (selected.length === 0) {
                let defaultText = 'All';
                if (filterType === 'workflowType') defaultText = 'All Types';
                else if (filterType === 'taskType') defaultText = 'All Tasks';
                else if (filterType === 'status') defaultText = 'All Statuses';
                else if (filterType === 'namespace') defaultText = 'All Namespaces';
                display.innerHTML = defaultText;
            } else if (selected.length === 1) {
                display.innerHTML = selected[0];
            } else {
                display.innerHTML = `<span class="selected-count">${selected.length} selected</span>`;
            }
        }

        function selectAllFilter(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = true);
            updateMultiSelectFilter(filterType);
        }

        function clearAllFilter(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = false);
            updateMultiSelectFilter(filterType);
        }

        function toggleFilterOption(filterType, value) {
            const checkbox = document.getElementById(`${filterType}_${value}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateMultiSelectFilter(filterType);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    dropdown.previousElementSibling.classList.remove('active');
                });
            }
        });

        // Switch between table and chart view
        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            document.getElementById('chartViewBtn').classList.toggle('active', view === 'chart');
            
            // Show/hide views
            document.getElementById('smartTableView').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('smartChartView').style.display = view === 'chart' ? 'block' : 'none';
            
            // Show/hide chart controls
            document.getElementById('chartControls').style.display = view === 'chart' ? 'block' : 'none';
            
            updateSmartView();
        }

        // Update smart view based on filters
        function updateSmartView() {
            const filteredData = applySmartFilters();
            
            // Update the filtered stats
            updateFilteredStats(filteredData);
            
            if (currentView === 'table') {
                updateSmartTable(filteredData);
            } else if (currentView === 'chart') {
                updateSmartChart(filteredData);
            }
        }

        // Apply filters to smart data
        function applySmartFilters() {
            const itemType = document.getElementById('itemTypeFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();

            let allItems = [];
            
            // Add workflows if needed
            if (itemType === 'all' || itemType === 'workflows') {
                allItems = allItems.concat(smartData.workflows || []);
            }
            
            // Add tasks if needed
            if (itemType === 'all' || itemType === 'tasks') {
                allItems = allItems.concat(smartData.tasks || []);
            }

            // Apply filters
            return allItems.filter(item => {
                // Workflow type filter - if any workflow types are selected, filter by them
                if (multiSelectFilters.workflowType.length > 0) {
                    if (!multiSelectFilters.workflowType.includes(item.workflow_type)) return false;
                }
                
                // Task type filter - if any task types are selected, filter by them (only for tasks)
                if (multiSelectFilters.taskType.length > 0 && item.type === 'task') {
                    if (!multiSelectFilters.taskType.includes(item.task_type)) return false;
                }
                
                // Status filter - if any statuses are selected, filter by them
                if (multiSelectFilters.status.length > 0) {
                    let matchesStatus = false;
                    for (const selectedStatus of multiSelectFilters.status) {
                        if (selectedStatus === 'deleted' && item.is_deleted) {
                            matchesStatus = true;
                            break;
                        }
                        if (selectedStatus !== 'deleted' && item.status.includes(selectedStatus)) {
                            matchesStatus = true;
                            break;
                        }
                    }
                    if (!matchesStatus) return false;
                }
                
                // Namespace filter - if any namespaces are selected, filter by them
                if (multiSelectFilters.namespace.length > 0) {
                    if (!multiSelectFilters.namespace.includes(item.namespace)) return false;
                }
                
                // Search filter
                if (search && !item.name.toLowerCase().includes(search)) return false;
                
                return true;
            });
        }

        // Update smart table
        function updateSmartTable(filteredData) {
            const tableView = document.getElementById('smartTableView');
            
            if (filteredData.length === 0) {
                tableView.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">filter_list</span>
                        <div class="empty-state-title">No Matching Items</div>
                        <div class="empty-state-description">No workflows or tasks match your current filter criteria. Try adjusting your filters.</div>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Workflow Type</th>
                            <th>Task Type</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Namespace</th>
                            <th>Parent Workflow</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => {
                            let rowClasses = [];
                            if (item.type === 'task') rowClasses.push('task-row');
                            if (item.is_deleted) rowClasses.push('deleted-row');
                            return `
                            <tr class="${rowClasses.join(' ')}">
                                <td><span class="type-badge type-${item.type}">${item.type}</span></td>
                                <td><strong>${item.name}</strong></td>
                                <td><span class="status-badge ${getStatusClass(item.status)}">${item.status}</span></td>
                                <td>${item.workflow_type || '-'}</td>
                                <td>${item.task_type || '-'}</td>
                                <td>${formatTimestamp(item.started_at)}</td>
                                <td>${formatDuration(item.duration_seconds)}</td>
                                <td><code>${item.namespace || '-'}</code></td>
                                <td>${item.workflow_name || item.name}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            tableView.innerHTML = tableHTML;
        }

        // Update smart chart - now shows individual executions as bar chart over time
        function updateSmartChart(filteredData) {
            const chartContainer = document.getElementById('smartChartView');
            const ctx = document.getElementById('smartChart').getContext('2d');
            
            // Ensure chart container is visible before creating chart
            if (currentView === 'chart' && chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            }
            
            if (smartChart) {
                smartChart.destroy();
            }

            // Filter out items without duration or start time
            const validData = filteredData.filter(item => 
                item.started_at && item.duration_seconds !== null && item.duration_seconds !== undefined
            );

            if (validData.length === 0) {
                const emptyChart = new Chart(ctx, {
                    type: 'bar',
                    data: { datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Performance Chart - No Data Available'
                            }
                        }
                    }
                });
                smartChart = emptyChart;
                return;
            }

            // Sort data by start time
            validData.sort((a, b) => new Date(a.started_at) - new Date(b.started_at));

            // Group data by type for different colors
            const groups = {};
            validData.forEach(item => {
                const groupKey = item.task_type || item.workflow_type || 'Other';
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                
                groups[groupKey].push({
                    x: new Date(item.started_at),
                    y: item.duration_seconds,
                    name: item.name,
                    status: item.status,
                    workflow_type: item.workflow_type,
                    task_type: item.task_type,
                    type: item.type
                });
            });

            // Create datasets with different colors for each group
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];

            const datasets = [];
            let colorIndex = 0;

            // Get time range for reference lines
            const minTime = Math.min(...validData.map(item => new Date(item.started_at).getTime()));
            const maxTime = Math.max(...validData.map(item => new Date(item.started_at).getTime()));

            // Check if reference lines should be shown
            const showAverageLines = document.getElementById('showAverageLines').checked;
            const showMedianLines = document.getElementById('showMedianLines').checked;

            Object.keys(groups).forEach(groupKey => {
                const color = colors[colorIndex % colors.length];
                const borderColor = color.replace('0.8', '1');
                colorIndex++;

                // Add bar chart dataset for this group
                datasets.push({
                    label: groupKey,
                    data: groups[groupKey],
                    backgroundColor: color,
                    borderColor: borderColor,
                    borderWidth: 1,
                    barThickness: 20,
                    maxBarThickness: 30,
                    type: 'bar'
                });

                // Calculate reference values
                const durations = groups[groupKey].map(item => item.y);
                const average = durations.reduce((sum, d) => sum + d, 0) / durations.length;
                const sortedDurations = [...durations].sort((a, b) => a - b);
                const median = sortedDurations[Math.floor(sortedDurations.length / 2)];

                // Add average line dataset
                if (showAverageLines) {
                    datasets.push({
                        label: `${groupKey} Average`,
                        data: [
                            { x: new Date(minTime), y: average },
                            { x: new Date(maxTime), y: average }
                        ],
                        type: 'line',
                        borderColor: borderColor,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }

                // Add median line dataset
                if (showMedianLines) {
                    datasets.push({
                        label: `${groupKey} Median`,
                        data: [
                            { x: new Date(minTime), y: median },
                            { x: new Date(maxTime), y: median }
                        ],
                        type: 'line',
                        borderColor: borderColor,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }
            });

            // Add a small delay to ensure canvas is properly sized
            setTimeout(() => {
                smartChart = new Chart(ctx, {
                    type: 'bar',
                    data: { datasets },
                    options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            title: {
                                display: true,
                                text: 'Start Time'
                            },
                            time: {
                                displayFormats: {
                                    minute: 'MMM dd HH:mm',
                                    hour: 'MMM dd HH:mm',
                                    day: 'MMM dd, yyyy',
                                    week: 'MMM dd, yyyy',
                                    month: 'MMM yyyy'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Duration (seconds)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Chart - Individual Executions with Reference Lines'
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                // Only show tooltips for bar chart data, not reference lines
                                return tooltipItem.dataset.type === 'bar' || !tooltipItem.dataset.type;
                            },
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('en-US', { 
                                        weekday: 'short', 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    if (point && point.name) {
                                        return [
                                            `${context.dataset.label}: ${formatDuration(point.y)}`,
                                            `Name: ${point.name}`,
                                            `Status: ${point.status}`,
                                            `Type: ${point.type}`,
                                            point.workflow_type ? `Workflow: ${point.workflow_type}` : '',
                                            point.task_type ? `Task: ${point.task_type}` : ''
                                        ].filter(Boolean);
                                    }
                                    return `${context.dataset.label}: ${formatDuration(context.parsed.y)}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                filter: function(legendItem, chartData) {
                                    // Group reference lines in legend
                                    return true;
                                }
                            }
                        }
                    }
                }
            });
            }, 10); // Small delay to ensure canvas is properly rendered
        }

        // Refresh all data
        async function refreshAllData() {
            if (isLoading) return;

            isLoading = true;
            refreshDataBtn.disabled = true;
            updateConnectionStatus('pending', 'Loading...');

            try {
                await loadSmartData();
                updateConnectionStatus('connected', 'Connected');
            } catch (error) {
                updateConnectionStatus('disconnected', 'Error');
                showConnectionAlert('danger', `Failed to load data: ${error.message}`);
            }

            isLoading = false;
            refreshDataBtn.disabled = false;
        }

        // Initial setup and data load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure initial view state is correct
            switchView('chart');
            
            // Run initial connection test and data load
            setTimeout(() => {
                testConnection().then(() => {
                    refreshAllData();
                });
            }, 500);
        });

        // Auto-refresh every 30 seconds
        setInterval(refreshAllData, 30000);
    </script>
</body>
</html> 